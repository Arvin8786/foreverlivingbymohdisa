<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Business Partner Portal | FL</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* [ 1.0 ] LUXURY VARIABLES & RESET */
        :root {
            --primary-color: #0a291f;      
            --secondary-color: #d4af37;    
            --bg-color: #fcfcfc;           
            --card-bg: #ffffff;            
            --text-main: #333333;
            --text-light: #777777;
            --danger-color: #a83232;
            --accent-color: #e9f0ee;
            --border-radius: 4px;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: var(--font-body); background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; }
        .container { max-width: 1300px; margin: 30px auto; padding: 0 30px; }
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-color); font-weight: 700; }
        
        /* [ 2.0 ] BUTTONS */
        .btn { 
            display: inline-block; padding: 12px 25px; 
            text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; font-weight: 700;
            border: 1px solid transparent; cursor: pointer; transition: 0.3s; text-align: center;
            border-radius: var(--border-radius); text-decoration: none;
        }
        .btn:disabled { background: #ccc !important; border-color: #ccc !important; cursor: not-allowed; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--secondary-color); border-color: var(--secondary-color); color: #000; }
        .btn-secondary { background: transparent; border-color: var(--primary-color); color: var(--primary-color); }
        .btn-secondary:hover:not(:disabled) { background: var(--primary-color); color: #fff; }
        .btn-danger { background: var(--danger-color); color: #fff; border-color: var(--danger-color); }
        
        /* [ 3.0 ] CARDS & LAYOUT */
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow-soft); padding: 30px; margin-bottom: 25px; border: 1px solid #eee; }
        .hidden { display: none !important; }

        /* [ 4.0 ] INPUTS */
        input, select, textarea { 
            width: 100%; padding: 12px 0; margin-bottom: 20px; border: none;
            border-bottom: 2px solid #ccc; background: transparent; font-size: 1rem;
            font-family: var(--font-body); transition: 0.3s; border-radius: 0;
        }
        input:focus, select:focus, textarea:focus { border-bottom-color: var(--secondary-color); }

        /* [ 5.0 ] LOGIN VIEW */
        #login-view { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary-color), #000); }
        #login-box { width: 500px; text-align: center; border-top: 5px solid var(--secondary-color); background: #fff; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        /* [ 6.0 ] HEADER & PROGRESS BAR */
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #eee; margin-bottom: 30px; }
        .target-bar-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .target-progress { height: 100%; background: var(--secondary-color); transition: width 0.5s; }

        /* [ 7.0 ] NAVIGATION */
        nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        nav .btn { flex-grow: 1; border: 1px solid #eee; background: #fff; color: var(--text-light); }
        nav .btn:hover { border-color: var(--secondary-color); color: var(--secondary-color); }
        nav .btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }

        /* [ 8.0 ] TABLES & MARKETPLACE */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        thead { background: var(--primary-color); color: #fff; }
        th { padding: 12px; text-align: left; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .open-order-card { padding: 20px; border: 1px solid #eee; margin-bottom: 15px; background: #fff; transition: 0.3s; position: relative; }
        .open-order-card:hover { border-color: var(--secondary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* [ 9.0 ] ORDER CREATION WORKFLOW */
        #order-creation-workflow { display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
        .product-item-selectable { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .product-item-selectable:hover { background: #f9f9f9; }
        .product-item-selectable img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
        
        /* [ 10.0 ] ADMIN TABS */
        .admin-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-link { padding: 10px 20px; cursor: pointer; color: #999; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .tab-link.active { color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); margin-bottom: -2px; }

        @media (max-width: 1000px) { #order-creation-workflow { grid-template-columns: 1fr; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script> 
</head>
<body>

<div id="login-view">
    <div id="login-box">
        <h1 style="color:var(--primary-color);">FL Portal</h1>
        <p style="margin-bottom: 20px;">Secure Business Partner Access</p>
        <form id="login-form" onsubmit="return false;">
            <input type="text" id="agent-id-input" placeholder="User ID" required>
            <input type="password" id="agent-password-input" placeholder="Password" required>
            <button type="button" id="login-btn" class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Secure Login</button>
            <p id="login-status" style="margin-top: 15px; font-size: 0.9rem; font-weight: 600; text-align: center;"></p>
        </form>
    </div>
</div>

<div id="password-change-view" class="container hidden">
    <div class="card" style="max-width: 450px; margin: 100px auto; text-align: center;">
        <h2>Security Update</h2>
        <p>Please update your default password to continue.</p>
        <input type="password" id="new-password-input" placeholder="New Password">
        <input type="password" id="confirm-password-input" placeholder="Confirm Password">
        <button class="btn btn-primary" style="width:100%;" onclick="handleChangePassword()">Update Password</button>
    </div>
</div>

<div id="portal-view" class="container hidden">
    <header>
        <div>
            <h2 id="agent-welcome-header"></h2>
            <p id="agent-details-display"></p>
            <div id="target-bar-display" style="margin-top: 10px;"></div>
        </div>
        <div style="text-align: right;">
            <button class="btn btn-secondary" onclick="fetchPortalData()">Refresh Data</button>
            <button id="logout-btn" class="btn btn-primary" onclick="location.reload()">Logout</button>
        </div>
    </header>

    <nav>
        <button id="nav-marketplace-btn" class="btn active" onclick="showView('marketplace-view')">Marketplace</button>
        <button id="nav-create-order-btn" class="btn" onclick="showView('create-order-view')">New Order</button>
        <button id="nav-catalog-btn" class="btn" onclick="showView('catalog-view')">Catalog</button>
        <button id="nav-my-orders-btn" class="btn" onclick="showView('my-orders-view')">My Sales</button>
        <button id="nav-income-btn" class="btn" onclick="showView('income-view')">Income</button>
        <button id="nav-learning-btn" class="btn" onclick="showView('learning-view')">Learning</button>
        <button id="nav-team-btn" class="btn hidden" onclick="showView('team-view')">Team</button>
        <button id="nav-admin-btn" class="btn hidden" onclick="showView('admin-view')">Admin</button>
        <button id="nav-profile-btn" class="btn" onclick="showView('profile-view')">Profile</button>
    </nav>

    <div id="marketplace-view" class="view">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Open Order Pool</h3>
                <span style="font-size:0.8rem; color:var(--text-light);">Orders from web/unassigned sources</span>
            </div>
            <div id="marketplace-list">Loading orders...</div>
        </div>
    </div>

    <div id="create-order-view" class="view hidden">
        <div id="order-creation-workflow">
            <div>
                <div class="card">
                    <h3>Customer Details</h3>
                    <select id="customer-dropdown" onchange="handleCustomerSelection()"></select>
                    <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="toggleNewCustomerForm()">+ New Customer</button>
                    <div id="new-customer-form" class="hidden" style="margin-top:20px;">
                        <input type="text" id="cust-name" placeholder="Full Name">
                        <input type="tel" id="cust-phone" placeholder="Phone">
                        <input type="email" id="cust-email" placeholder="Email">
                        <textarea id="cust-address" placeholder="Shipping Address"></textarea>
                    </div>
                </div>
                <div class="card">
                    <h3>Products</h3>
                    <input type="text" id="product-search" placeholder="Search SKU or Name..." onkeyup="filterProductSelection()">
                    <div id="product-selection-list"></div>
                </div>
            </div>
            <div class="card">
                <h3>Order Summary</h3>
                <div id="summary-items" style="min-height:100px;"></div>
                <div style="border-top:2px solid #eee; margin-top:20px; padding-top:15px;">
                    <div style="display:flex; justify-content:space-between;"><span>Subtotal:</span><span id="subtotal-val">RM 0.00</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Shipping:</span><span id="shipping-val">RM 0.00</span></div>
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.2rem; margin-top:10px; color:var(--primary-color);">
                        <span>Total:</span><span id="total-val">RM 0.00</span>
                    </div>
                </div>
                <div style="margin-top:30px;">
                    <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase;">Upload Payment Receipt</label>
                    <input type="file" id="payment-receipt" style="margin-top:10px;">
                    <button id="submit-order-btn" class="btn btn-primary" style="width:100%;" onclick="submitOrder()">Submit Order</button>
                </div>
            </div>
        </div>
    </div>

    <div id="catalog-view" class="view hidden card">
        <h3>Product Catalog</h3>
        <table>
            <thead><tr><th>SKU</th><th>Product Name</th><th>RSP (RM)</th><th>CC Value</th></tr></thead>
            <tbody id="catalog-table-body"></tbody>
        </table>
    </div>

    <div id="my-orders-view" class="view hidden card">
        <h3>My Sales History</h3>
        <div id="my-sales-list"></div>
    </div>

    <div id="income-view" class="view hidden card">
        <h3>Commission Statements</h3>
        <div id="income-list"></div>
    </div>

    <div id="team-view" class="view hidden card">
        <h3>My Team Performance</h3>
        <div style="background:var(--accent-color); padding:20px; border-radius:4px; margin-bottom:25px;">
            <label>Current Month Team Override</label>
            <div id="team-override-amt" style="font-size:2rem; font-weight:700; color:var(--primary-color);">RM 0.00</div>
        </div>
        <h4>Team Members</h4>
        <div id="team-list"></div>
    </div>

    <div id="admin-view" class="view hidden card">
        <div class="admin-tabs">
            <span class="tab-link active" onclick="switchAdminTab('performance')">Performance</span>
            <span class="tab-link" onclick="switchAdminTab('payroll')">Payroll</span>
            <span class="tab-link" onclick="switchAdminTab('staff')">Staff Management</span>
            <span class="tab-link" onclick="switchAdminTab('learning-mgmt')">Learning</span>
        </div>
        
        <div id="admin-performance">
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:30px;">
                <div style="background:#f9f9f9; padding:20px; text-align:center;"><label>Total Sales</label><div id="adm-total-sales" style="font-size:1.5rem; font-weight:700;">RM 0</div></div>
                <div style="background:#f9f9f9; padding:20px; text-align:center;"><label>Total CC</label><div id="adm-total-cc" style="font-size:1.5rem; font-weight:700;">0</div></div>
                <div style="background:#f9f9f9; padding:20px; text-align:center;"><label>Active Agents</label><div id="adm-active-agents" style="font-size:1.5rem; font-weight:700;">0</div></div>
            </div>
            <canvas id="adminChart" height="100"></canvas>
            <div id="admin-agent-table" style="margin-top:30px;"></div>
        </div>

        <div id="admin-payroll" class="hidden">
            <div style="background:#fff3cd; padding:15px; margin-bottom:20px; border-radius:4px; font-size:0.9rem;">
                <strong>Payroll Workflow:</strong> Confirm amounts -> Lock Batch -> Release Payment.
            </div>
            <div style="margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="adminLockPayroll()">Lock Batch</button>
                <button class="btn btn-danger" onclick="adminReleasePayroll()">Release Payment</button>
            </div>
            <div id="admin-payroll-table"></div>
        </div>

        <div id="admin-staff" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h4>Employee Directory</h4>
                <button class="btn btn-primary" onclick="openStaffModal()">+ Add New Agent</button>
            </div>
            <div id="admin-staff-list"></div>
        </div>
    </div>

    <div id="profile-view" class="view hidden card">
        <h3>My Profile</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px; margin-top:20px;">
            <div>
                <h4>Personal Information</h4>
                <label>Full Name</label><input id="prof-name" disabled>
                <label>Agent ID</label><input id="prof-id" disabled>
                <label>Role</label><input id="prof-role" disabled>
            </div>
            <div>
                <h4>Banking Information</h4>
                <p style="font-size:0.8rem; color:var(--text-light); margin-bottom:10px;">Used for commission payouts.</p>
                <label>Bank Name</label><input id="prof-bank">
                <label>Account Holder</label><input id="prof-acc-holder">
                <label>Account Number</label><input id="prof-acc-num">
                <button class="btn btn-primary" style="width:100%;" onclick="updateProfile()">Save Profile</button>
            </div>
        </div>
    </div>

    <div id="learning-view" class="view hidden card" style="text-align:center; padding:60px;">
        <i class="fas fa-graduation-cap" style="font-size:4rem; color:var(--secondary-color); margin-bottom:20px;"></i>
        <h3>FL Development Center</h3>
        <p>Access exclusive SORA 2 materials and AI tools below.</p>
        <div id="learning-links" style="margin-top:40px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="accessSora()">Access SORA 2</button>
        </div>
    </div>

</div>

<div id="sora-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:flex; justify-content:center; align-items:center;">
    <div class="card" style="width:400px; text-align:center;">
        <i class="fas fa-key" style="font-size:2rem; color:var(--secondary-color); margin-bottom:15px;"></i>
        <h3>SORA Access</h3>
        <div id="sora-creds" style="background:#f9f9f9; padding:20px; margin:20px 0; font-family:monospace; text-align:left; border:1px solid #eee;"></div>
        <button class="btn btn-primary" style="width:100%;" onclick="window.open('https://sora.com', '_blank')">Go to Sora</button>
        <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="document.getElementById('sora-modal').classList.add('hidden')">Close</button>
    </div>
</div>

<script>
// =================================================================
// 1. CONFIGURATION & STATE
// =================================================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby6haFUhB-Vds1JemMGxxsgUHAuKmZ6cjlR1B2mGtYHsHVSQik3h9MgswOQVIkzS_c84A/exec";

let appState = {
    agent: null,
    products: [],
    customers: [],
    shippingRules: [],
    cart: [],
    adminChart: null
};

// =================================================================
// 2. CORE FUNCTIONS (LOGIN & INIT)
// =================================================================

async function handleLogin() {
    const id = document.getElementById('agent-id-input').value.trim();
    const pw = document.getElementById('agent-password-input').value;
    const btn = document.getElementById('login-btn');
    const status = document.getElementById('login-status');
    
    if(!id || !pw) return alert("Enter credentials");

    btn.disabled = true;
    btn.textContent = "Authenticating...";
    
    try {
        const res = await callBackend('verifyAgent', { agentId: id, password: pw });
        if(res.success) {
            appState.agent = res.agent;
            
            if(res.mustChangePassword) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('password-change-view').classList.remove('hidden');
                return;
            }
            
            await initializePortal();
        } else {
            status.textContent = res.message;
            btn.disabled = false;
            btn.textContent = "Secure Login";
        }
    } catch(e) {
        status.textContent = "Server connection failed.";
        btn.disabled = false;
    }
}

async function initializePortal() {
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('portal-view').classList.remove('hidden');
    
    document.getElementById('agent-welcome-header').textContent = `Welcome, ${appState.agent.name}`;
    document.getElementById('agent-details-display').textContent = `${appState.agent.position} | ID: ${appState.agent.id}`;
    
    // Role based buttons
    if(appState.agent.isAdmin) document.getElementById('nav-admin-btn').classList.remove('hidden');
    if(appState.agent.isManager) document.getElementById('nav-team-btn').classList.remove('hidden');
    
    await fetchPortalData();
    renderTargetBar();
    showView('marketplace-view');
}

async function fetchPortalData() {
    const res = await callBackend('getPortalData', { agentId: appState.agent.id });
    if(res.success) {
        appState.products = res.products;
        appState.customers = res.customers;
        appState.shippingRules = res.shippingRules;
        
        renderCatalog();
        renderCustomerDropdown();
        renderProductSelection();
    }
}

// =================================================================
// 3. UI NAVIGATION
// =================================================================

function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.querySelectorAll('nav .btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(viewId).classList.remove('hidden');
    const navId = viewId.replace('-view', '');
    const navBtn = document.getElementById(`nav-${navId}-btn`);
    if(navBtn) navBtn.classList.add('active');

    // View specific triggers
    if(viewId === 'marketplace-view') renderMarketplace();
    if(viewId === 'my-orders-view') renderMySales();
    if(viewId === 'income-view') renderIncome();
    if(viewId === 'team-view') renderTeam();
    if(viewId === 'admin-view') switchAdminTab('performance');
    if(viewId === 'profile-view') populateProfile();
    if(viewId === 'learning-view') loadLearningLinks();
}

// =================================================================
// 4. ORDER & CART LOGIC
// =================================================================

function renderProductSelection() {
    const container = document.getElementById('product-selection-list');
    container.innerHTML = appState.products.map(p => `
        <div class="product-item-selectable" onclick="addToCart('${p.id}')">
            <img src="FL_thumb.jpg" onerror="this.src='https://via.placeholder.com/60?text=Product'">
            <div style="flex-grow:1;">
                <strong>${p.name}</strong><br>
                <small>SKU: ${p.id} | RSP: RM ${p.rsp.toFixed(2)}</small>
            </div>
            <i class="fas fa-plus-circle" style="color:var(--secondary-color);"></i>
        </div>
    `).join('');
}

function addToCart(sku) {
    const p = appState.products.find(x => x.id === sku);
    const existing = appState.cart.find(i => i.id === sku);
    if(existing) {
        existing.qty++;
    } else {
        appState.cart.push({ ...p, qty: 1 });
    }
    renderCart();
}

function renderCart() {
    const container = document.getElementById('summary-items');
    if(appState.cart.length === 0) {
        container.innerHTML = "<p style='text-align:center; color:#ccc; margin-top:20px;'>Cart is empty</p>";
        updateTotals(0);
        return;
    }
    
    let subtotal = 0;
    container.innerHTML = appState.cart.map(item => {
        subtotal += (item.rsp * item.qty);
        return `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                <div><strong>${item.name}</strong><br><small>RM ${item.rsp.toFixed(2)} x ${item.qty}</small></div>
                <div style="text-align:right;">
                    RM ${(item.rsp * item.qty).toFixed(2)}<br>
                    <span onclick="removeFromCart('${item.id}')" style="color:red; cursor:pointer; font-size:0.7rem;">Remove</span>
                </div>
            </div>
        `;
    }).join('');
    
    updateTotals(subtotal);
}

function updateTotals(subtotal) {
    let ship = 0;
    if(subtotal > 0 && appState.shippingRules.length > 0) {
        const rule = appState.shippingRules.find(r => subtotal >= r.minSpend);
        ship = rule ? rule.charge : appState.shippingRules[0].charge;
    }
    
    document.getElementById('subtotal-val').textContent = `RM ${subtotal.toFixed(2)}`;
    document.getElementById('shipping-val').textContent = `RM ${ship.toFixed(2)}`;
    document.getElementById('total-val').textContent = `RM ${(subtotal + ship).toFixed(2)}`;
}

function removeFromCart(sku) {
    appState.cart = appState.cart.filter(i => i.id !== sku);
    renderCart();
}

async function submitOrder() {
    const btn = document.getElementById('submit-order-btn');
    const receipt = document.getElementById('payment-receipt').files[0];
    
    if(appState.cart.length === 0) return alert("Cart is empty");
    if(!receipt) return alert("Please upload payment receipt");
    
    // Get Customer Data
    let customer = {};
    const dropdown = document.getElementById('customer-dropdown').value;
    if(dropdown === "NEW" || !dropdown) {
        customer = {
            name: document.getElementById('cust-name').value,
            phone: document.getElementById('cust-phone').value,
            email: document.getElementById('cust-email').value,
            address: document.getElementById('cust-address').value
        };
        if(!customer.name || !customer.phone) return alert("Customer name and phone required");
    } else {
        customer = appState.customers.find(c => c.id === dropdown);
    }

    btn.disabled = true;
    btn.textContent = "Submitting...";

    try {
        const base64Receipt = await toBase64(receipt);
        const payload = {
            agentId: appState.agent.id,
            customer: customer,
            items: appState.cart,
            receipt: base64Receipt.split(',')[1]
        };
        
        const res = await callBackend('submitOrder', payload);
        if(res.success) {
            alert("Order Submitted Successfully! Invoice: " + res.invoiceId);
            appState.cart = [];
            renderCart();
            showView('my-orders-view');
        } else {
            alert("Error: " + res.message);
        }
    } catch(e) {
        alert("Submission Failed.");
    } finally {
        btn.disabled = false;
        btn.textContent = "Submit Order";
    }
}

// =================================================================
// 5. MARKETPLACE LOGIC
// =================================================================

async function renderMarketplace() {
    const container = document.getElementById('marketplace-list');
    container.innerHTML = "Fetching pool orders...";
    
    const res = await callBackend('getOpenOrders', {});
    if(res.success && res.orders.length > 0) {
        container.innerHTML = res.orders.map(o => `
            <div class="open-order-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong style="color:var(--primary-color);">${o.invoiceId}</strong><br>
                        <span>${o.customerName}</span> | RM ${o.total.toFixed(2)}
                    </div>
                    <button class="btn btn-primary" style="padding:8px 15px;" onclick="claimOrder('${o.invoiceId}')">Pick Order</button>
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = "<p style='padding:40px; text-align:center;'>No open orders in pool.</p>";
    }
}

async function claimOrder(invId) {
    if(!confirm("Claim this order as your sale?")) return;
    const res = await callBackend('claimOrder', { agentId: appState.agent.id, invoiceId: invId });
    if(res.success) {
        alert("Order claimed!");
        renderMarketplace();
    } else {
        alert(res.message);
    }
}

// =================================================================
// 6. ADMIN VIEW LOGIC
// =================================================================

function switchAdminTab(tab) {
    document.getElementById('admin-performance').classList.add('hidden');
    document.getElementById('admin-payroll').classList.add('hidden');
    document.getElementById('admin-staff').classList.add('hidden');
    document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
    
    document.querySelector(`[onclick="switchAdminTab('${tab}')"]`).classList.add('active');
    
    if(tab === 'performance') {
        document.getElementById('admin-performance').classList.remove('hidden');
        loadAdminPerformance();
    } else if(tab === 'payroll') {
        document.getElementById('admin-payroll').classList.remove('hidden');
        loadAdminPayroll();
    } else if(tab === 'staff') {
        document.getElementById('admin-staff').classList.remove('hidden');
        loadAdminStaff();
    }
}

async function loadAdminPerformance() {
    const res = await callBackend('getAdminData', { agentId: appState.agent.id });
    if(res.success) {
        document.getElementById('adm-total-sales').textContent = `RM ${res.totals.sales.toFixed(2)}`;
        document.getElementById('adm-total-cc').textContent = res.totals.cc.toFixed(2);
        document.getElementById('adm-active-agents').textContent = res.totals.activeAgents;
        
        // Chart
        const ctx = document.getElementById('adminChart').getContext('2d');
        if(appState.adminChart) appState.adminChart.destroy();
        appState.adminChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: res.agentStats.map(a => a.name),
                datasets: [{
                    label: 'Sales Revenue (RM)',
                    data: res.agentStats.map(a => a.sales),
                    backgroundColor: '#0a291f'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
        
        // Table
        document.getElementById('admin-agent-table').innerHTML = `
            <table>
                <thead><tr><th>Agent Name</th><th>Sales</th><th>CC</th><th>Target %</th></tr></thead>
                <tbody>${res.agentStats.map(a => `<tr><td>${a.name}</td><td>RM ${a.sales.toFixed(2)}</td><td>${a.cc}</td><td>${a.targetPct}%</td></tr>`).join('')}</tbody>
            </table>
        `;
    }
}

// =================================================================
// 7. UTILITIES & BACKEND
// =================================================================

async function callBackend(action, data) {
    const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, data })
    });
    return await res.json();
}

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

// Init on Load
// (EventListeners already set in HTML tags)

</script>
</body>
</html>
