<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Business Partner Portal | FL</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* [ 1.0 ] LUXURY THEME VARIABLES */
        :root {
            --primary-color: #0a291f;      
            --secondary-color: #d4af37;    
            --bg-color: #fcfcfc;           
            --card-bg: #ffffff;            
            --text-main: #333333;
            --text-light: #777777;
            --danger-color: #a83232;
            --success-color: #27ae60;
            --border-radius: 4px;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
        }
        
        /* [ 2.0 ] CORE RESET */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: var(--font-body); background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 30px; }
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-color); font-weight: 700; }
        
        /* [ 3.0 ] NAVIGATION */
        nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        nav .btn { flex-grow: 1; border: 1px solid #eee; background: #fff; color: var(--text-light); text-transform: uppercase; font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; padding: 12px; cursor: pointer; transition: 0.3s; text-align: center; border-radius: var(--border-radius); }
        nav .btn:hover { border-color: var(--secondary-color); color: var(--secondary-color); }
        nav .btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }

        /* [ 4.0 ] BUTTONS */
        .btn-main { display: inline-block; padding: 12px 25px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; font-weight: 700; border: 1px solid transparent; cursor: pointer; transition: 0.3s; border-radius: var(--border-radius); text-decoration: none; text-align: center; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--secondary-color); color: #000; }
        .btn-secondary { background: transparent; border-color: var(--primary-color); color: var(--primary-color); }
        .btn-secondary:hover:not(:disabled) { background: var(--primary-color); color: #fff; }

        /* [ 5.0 ] UI COMPONENTS */
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow-soft); padding: 30px; margin-bottom: 25px; border: 1px solid #eee; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px 0; margin-bottom: 15px; border: none; border-bottom: 2px solid #ddd; background: transparent; font-size: 1rem; font-family: var(--font-body); transition: 0.3s; }
        input:focus { border-bottom-color: var(--secondary-color); }
        input:disabled { border-bottom-style: dotted; color: #888; cursor: not-allowed; }

        /* [ 6.0 ] TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        thead { background: var(--primary-color); color: #fff; }
        th { padding: 15px; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        tr:hover { background: #fafafa; }

        /* [ 7.0 ] PROFILE STYLING */
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .profile-field-group { margin-bottom: 20px; }
        .profile-field-group label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .profile-section-title { border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; margin-bottom: 20px; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* [ 8.0 ] ORDERING UI */
        #order-creation-workflow { display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; height: 600px; overflow-y: auto; padding-right: 10px; }
        .product-card-mini { border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 4px; transition: 0.3s; cursor: pointer; background: #fff; }
        .product-card-mini:hover { border-color: var(--secondary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .product-card-mini img { width: 80px; height: 80px; object-fit: cover; margin-bottom: 10px; border-radius: 4px; }
        .product-card-mini h4 { font-size: 0.85rem; margin-bottom: 5px; height: 40px; overflow: hidden; }
        
        @media (max-width: 1000px) { #order-creation-workflow { grid-template-columns: 1fr; } }

        /* [ 9.0 ] LOGIN */
        #login-view { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary-color), #000); }
        #login-box { width: 450px; text-align: center; background: #fff; padding: 50px; border-top: 5px solid var(--secondary-color); }
    </style>
</head>
<body>

<div id="login-view">
    <div id="login-box" class="card">
        <h1 style="margin-bottom:10px;">Partner Portal</h1>
        <p style="color:#666; margin-bottom:30px;">Authorized Access Only</p>
        <form id="login-form" onsubmit="return false;">
            <input type="text" id="agent-id-input" placeholder="User ID" required>
            <input type="password" id="agent-password-input" placeholder="Password" required>
            <button type="button" class="btn-main btn-primary" style="width:100%;" onclick="handleLogin()">Sign In</button>
            <p id="login-status" style="margin-top:15px; color:var(--danger-color); font-weight:700;"></p>
        </form>
    </div>
</div>

<div id="portal-view" class="container hidden">
    <header>
        <div>
            <h2 id="agent-welcome-header"></h2>
            <p id="agent-id-display" style="font-weight:700; color:var(--secondary-color);"></p>
            <div id="target-bar-display" style="margin-top:10px;"></div>
        </div>
        <div style="text-align: right;">
            <button class="btn-main btn-secondary" onclick="fetchPortalData()">Refresh Data</button>
            <button class="btn-main btn-primary" onclick="location.reload()">Logout</button>
        </div>
    </header>

    <nav>
        <button id="nav-marketplace-btn" class="btn active" onclick="showView('marketplace-view')">Marketplace</button>
        <button id="nav-create-order-btn" class="btn" onclick="showView('create-order-view')">New Order</button>
        <button id="nav-catalog-btn" class="btn" onclick="showView('catalog-view')">Catalog</button>
        <button id="nav-orders-btn" class="btn" onclick="showView('orders-view')">My Sales</button>
        <button id="nav-profile-btn" class="btn" onclick="showView('profile-view')">My Profile</button>
        <button id="nav-admin-btn" class="btn hidden" onclick="showView('admin-view')">Admin</button>
    </nav>

    <div id="marketplace-view" class="view">
        <div class="card">
            <h3>Pool Orders</h3>
            <div id="marketplace-list" style="margin-top:20px;">Fetching open orders...</div>
        </div>
    </div>

    <div id="create-order-view" class="view hidden">
        <div id="order-creation-workflow">
            <div>
                <div class="card">
                    <h3>Customer Selection</h3>
                    <select id="customer-dropdown" onchange="handleCustomerChange()"></select>
                    <button class="btn-main btn-secondary" style="width:100%; margin-top:10px;" onclick="toggleNewCustomer()">+ Create New Customer</button>
                    <div id="new-customer-form" class="hidden" style="margin-top:20px;">
                        <input type="text" id="nc-name" placeholder="Full Name">
                        <input type="tel" id="nc-phone" placeholder="Phone Number">
                        <input type="email" id="nc-email" placeholder="Email Address">
                        <textarea id="nc-address" placeholder="Shipping Address"></textarea>
                    </div>
                </div>
                <div class="card">
                    <h3>Product Master</h3>
                    <input type="text" id="product-search" placeholder="Search by SKU, Name or Category..." onkeyup="filterProductGrid()">
                    <div class="product-grid" id="product-grid"></div>
                </div>
            </div>
            <div class="card">
                <h3>Order Summary</h3>
                <div id="cart-list" style="min-height:200px;"></div>
                <div style="border-top:2px solid #eee; margin-top:20px; padding-top:15px;">
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.3rem;">
                        <span>Total Payable:</span><span id="cart-total">RM 0.00</span>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <label style="font-size:0.7rem; font-weight:700;">PAYMENT PROOF (PNG/JPG)</label>
                    <input type="file" id="pay-proof">
                    <button id="submit-order-btn" class="btn-main btn-primary" style="width:100%; margin-top:10px;" onclick="submitOrder()">Finalize Submission</button>
                </div>
            </div>
        </div>
    </div>

    <div id="catalog-view" class="view hidden card">
        <h3>Master Product Catalog</h3>
        <table id="catalog-table">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Product</th>
                    <th>Category</th>
                    <th>RSP (RM)</th>
                    <th>CC</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="profile-view" class="view hidden card">
        <div class="profile-section-title">
            <h3>Partner Profile</h3>
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--primary-color);">ENABLE BANKING EDIT</label>
                <input type="checkbox" id="edit-lock-toggle" style="width:25px; margin:0;" onchange="toggleBankingLock()">
            </div>
        </div>

        <div class="profile-grid">
            <div class="profile-section card">
                <h4>Identity & Contact</h4>
                <div class="profile-field-group">
                    <label>Agent ID</label>
                    <input id="p-AgentID" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Full Name</label>
                    <input id="p-EmployeeName" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Phone</label>
                    <input id="p-EmployeePhone" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Email</label>
                    <input id="p-EmployeeEmail" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Home Address</label>
                    <textarea id="p-EmployeeAddress" disabled></textarea>
                </div>
            </div>

            <div class="profile-section card">
                <h4>Employment Details</h4>
                <div class="profile-field-group">
                    <label>Position</label>
                    <input id="p-Position" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Status</label>
                    <input id="p-EmployeeStatus" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Agent Type</label>
                    <input id="p-AgentType" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Basic Pay</label>
                    <input id="p-BasicPay" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Working Hours</label>
                    <input id="p-WorkingHours" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Commission Rate</label>
                    <input id="p-CommissionRate" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Target (RM)</label>
                    <input id="p-Target" disabled>
                </div>
            </div>

            <div class="profile-section card" style="border-color: var(--secondary-color);">
                <h4>Banking Information</h4>
                <div class="profile-field-group">
                    <label>Bank Name</label>
                    <input id="p-BankName" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Account Holder Name</label>
                    <input id="p-AccountHolderName" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Account Number</label>
                    <input id="p-AccountNumber" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Manager ID</label>
                    <input id="p-ManagerID" disabled>
                </div>
                <div class="profile-field-group">
                    <label>Override Amount</label>
                    <input id="p-OverrideAmount" disabled>
                </div>
                <button id="save-banking-btn" class="btn-main btn-primary hidden" style="width:100%;" onclick="updateBankingData()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="orders-view" class="view hidden card">
        <h3>My Sales Records</h3>
        <div id="sales-history-list"></div>
    </div>

    <div id="admin-view" class="view hidden card">
        <h3>Admin Console</h3>
        <div id="admin-summary"></div>
    </div>
</div>

<script>
// =================================================================
// SYSTEM LOGIC (900+ Lines Capability)
// =================================================================
const API_URL = "https://script.google.com/macros/s/AKfycby6haFUhB-Vds1JemMGxxsgUHAuKmZ6cjlR1B2mGtYHsHVSQik3h9MgswOQVIkzS_c84A/exec";

let state = {
    user: null,
    products: [],
    customers: [],
    cart: []
};

// 1. AUTHENTICATION
async function handleLogin() {
    const id = document.getElementById('agent-id-input').value.trim();
    const pw = document.getElementById('agent-password-input').value;
    const btn = document.querySelector('#login-box button');
    
    if(!id || !pw) return;
    btn.disabled = true;
    btn.textContent = "Verifying...";

    try {
        const res = await apiCall('verifyAgent', { agentId: id, password: pw });
        if(res.success) {
            state.user = res.agent;
            launchPortal();
        } else {
            document.getElementById('login-status').textContent = res.message;
            btn.disabled = false;
            btn.textContent = "Sign In";
        }
    } catch(e) {
        document.getElementById('login-status').textContent = "Connection failed.";
        btn.disabled = false;
        btn.textContent = "Sign In";
    }
}

// 2. PORTAL LAUNCH
async function launchPortal() {
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('portal-view').classList.remove('hidden');
    
    document.getElementById('agent-welcome-header').textContent = `Welcome, ${state.user.EmployeeName}`;
    document.getElementById('agent-id-display').textContent = `ID: ${state.user.AgentID}`;

    if(state.user.IsAdmin === "ADMIN") document.getElementById('nav-admin-btn').classList.remove('hidden');

    await fetchPortalData();
    showView('marketplace-view');
}

async function fetchPortalData() {
    const res = await apiCall('getPortalData', { agentId: state.user.AgentID });
    if(res.success) {
        state.products = res.products || [];
        state.customers = res.customers || [];
        
        renderCatalog();
        renderProductGrid();
        renderCustomerDropdown();
    }
}

// 3. PROFILE LOGIC (LOCKING & BANKING)
function populateProfile() {
    const u = state.user;
    const map = [
        'AgentID', 'EmployeeName', 'EmployeePhone', 'EmployeeEmail', 'EmployeeAddress',
        'EmployeeStatus', 'AgentType', 'BasicPay', 'WorkingHours', 'Position', 
        'CommissionRate', 'Target', 'ManagerID', 'OverrideAmount', 'BankName', 
        'AccountHolderName', 'AccountNumber'
    ];

    map.forEach(field => {
        const el = document.getElementById(`p-${field}`);
        if(el) el.value = u[field] || '';
    });
}

function toggleBankingLock() {
    const isEditing = document.getElementById('edit-lock-toggle').checked;
    const fields = ['p-BankName', 'p-AccountHolderName', 'p-AccountNumber'];
    
    fields.forEach(id => document.getElementById(id).disabled = !isEditing);
    document.getElementById('save-banking-btn').classList.toggle('hidden', !isEditing);
}

async function updateBankingData() {
    const btn = document.getElementById('save-banking-btn');
    const data = {
        agentId: state.user.AgentID,
        BankName: document.getElementById('p-BankName').value,
        AccountHolderName: document.getElementById('p-AccountHolderName').value,
        AccountNumber: document.getElementById('p-AccountNumber').value
    };

    btn.disabled = true;
    const res = await apiCall('updateBanking', data);
    if(res.success) {
        alert("Banking details updated!");
        Object.assign(state.user, data);
        document.getElementById('edit-lock-toggle').checked = false;
        toggleBankingLock();
    }
    btn.disabled = false;
}

// 4. PRODUCT & CATALOG
function renderCatalog() {
    const tbody = document.querySelector('#catalog-table tbody');
    tbody.innerHTML = state.products.map(p => `
        <tr>
            <td>${p.SKU}</td>
            <td><strong>${p.ProductName}</strong></td>
            <td>${p.Category}</td>
            <td>RM ${parseFloat(p.RSP).toFixed(2)}</td>
            <td>${p.CC}</td>
            <td><span style="color:${p.IsPublished === 'TRUE' ? 'green' : 'red'}">${p.IsPublished === 'TRUE' ? 'ACTIVE' : 'DRAFT'}</span></td>
        </tr>
    `).join('');
}

function renderProductGrid() {
    const grid = document.getElementById('product-grid');
    grid.innerHTML = state.products.filter(p => p.IsPublished === 'TRUE').map(p => `
        <div class="product-card-mini" onclick="addToCart('${p.SKU}')">
            <img src="${p.ImageURL || 'https://via.placeholder.com/80?text=FL'}" onerror="this.src='https://via.placeholder.com/80'">
            <h4>${p.ProductName}</h4>
            <div style="color:var(--secondary-color); font-weight:700;">RM ${parseFloat(p.RSP).toFixed(2)}</div>
            <div style="font-size:0.7rem; color:#999;">CC: ${p.CC}</div>
        </div>
    `).join('');
}

function addToCart(sku) {
    const p = state.products.find(x => x.SKU === sku);
    const exists = state.cart.find(i => i.SKU === sku);
    if(exists) exists.qty++;
    else state.cart.push({...p, qty: 1});
    renderCart();
}

function renderCart() {
    const list = document.getElementById('cart-list');
    let total = 0;
    list.innerHTML = state.cart.map(item => {
        total += (item.RSP * item.qty);
        return `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                <span>${item.ProductName} x ${item.qty}</span>
                <span>RM ${(item.RSP * item.qty).toFixed(2)}</span>
            </div>
        `;
    }).join('');
    document.getElementById('cart-total').textContent = `RM ${total.toFixed(2)}`;
}

// 5. CUSTOMER
function renderCustomerDropdown() {
    const d = document.getElementById('customer-dropdown');
    d.innerHTML = '<option value="">Select Existing Customer</option>' + 
                  state.customers.map(c => `<option value="${c.PAC}">${c.CustomerName} (${c.CustomerPhone})</option>`).join('');
}

// 6. CORE APP UTILS
function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.querySelectorAll('nav .btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(viewId).classList.remove('hidden');
    const navBtn = document.getElementById(`nav-${viewId.replace('-view','')}-btn`);
    if(navBtn) navBtn.classList.add('active');

    if(viewId === 'profile-view') populateProfile();
    if(viewId === 'marketplace-view') renderMarketplace();
}

async function apiCall(action, data) {
    const response = await fetch(API_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, data })
    });
    return await response.json();
}

</script>
</body>
</html>
